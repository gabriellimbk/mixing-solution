<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>• Mixing of solutions •</title>
    <style>
        :root{
            --bg:#ffffff;
            --panel:#f8f9fa;
            --ink:#000000;
            --muted:#6c757d;
            --blue:#0066cc;
            --green:#00aa44;
            --red:#dc3545;
            --cyan:#0088aa;
            --border:#333333;
        }

        *{ box-sizing:border-box; }

        body {
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
            max-width: 100%;
            margin: 0;
            padding: 0;
            background: var(--bg);
            color: var(--ink);
            min-height: 100dvh;
        }

        .container {
            background: var(--panel);
            border-radius: 18px;
            padding: 16px 20px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 880px;
            margin: 24px auto 32px;
            border: 4px solid var(--border);
        }

        .top-header{
            margin:-16px -20px 16px;
            padding:18px 20px 10px;
            text-align:center;
            background:linear-gradient(to bottom,#e8f4f8,#ffffff);
            border-bottom:4px solid var(--border);
            border-radius:14px 14px 0 0;
        }
        
        h1 {
            color: #000;
            text-align: center;
            margin: 0;
            font-size: 1.8em;
            font-weight: 800;
        }

        .subtitle {
            text-align: center;
            color: var(--muted);
            margin: .35rem 0 0.2rem;
            font-size: 0.98rem;
        }
        
        .main-section {
            display: flex;
            gap: 40px;
            align-items: flex-start;
            margin-bottom: 15px;
            justify-content: center;
            max-width: 760px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .main-section.hidden {
            display: none;
        }
        
        .beaker-group {
            flex: 0 0 240px;
        }
        
        .beaker-display {
            text-align: center;
            margin-bottom: 8px;
            position: relative;
        }
        
        /* Static beakers: start empty */
        .beaker-visual {
            width: 135px;
            height: 165px;
            margin: 0 auto 6px;
            position: relative;
            border: 4px solid var(--blue);
            border-top: none;
            border-radius: 0 0 50px 50px;
            transition: all 0.5s ease;
            background: linear-gradient(to bottom, transparent 100%);
        }

        /* Shared "cell" style for solution description (static + animated) */
        .beaker-content,
        .beaker-content-anim {
            position: static;
            transform: none;
            margin: 4px auto 0;
            display: inline-block;
            min-width: 140px;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.78em;
            line-height: 1.2;
            text-align: center;
            word-wrap: break-word;
            color: #000;
            border: 2px solid rgba(0,0,0,0.25);
            background: #f0f0f0;
        }
        
        .radio-section {
            background: #fff;
            padding: 6px;
            border-radius: 12px;
            border: 2px solid var(--border);
        }
        
        .radio-section.hidden {
            display: none;
        }
        
        /* reduced vertical height of radio cells */
        .radio-option {
            display: flex;
            align-items: center;
            margin: 2px 0;
            padding: 3px 7px;
            background: #fdfdfd;
            border-radius: 9px;
            cursor: pointer;
            transition: all 0.25s ease;
            border: 2px solid transparent;
        }
        
        .radio-option:hover {
            background: #e6f2ff;
            transform: translateX(1px);
        }
        
        .radio-option input[type="radio"]:checked + label {
            font-weight: 600;
        }
        
        .radio-option.selected {
            background: #e6f2ff;
            border: 2px solid var(--blue);
        }
        
        input[type="radio"] {
            margin-right: 5px;
            transform: scale(0.9);
        }
        
        label {
            cursor: pointer;
            flex: 1;
        }
        
        .solution-info {
            font-size: 0.76em;
            color: #333;
            margin-left: 1px;
        }

        .solution-line {
            display: block;
            line-height: 1.15;
        }

        .ksp-display {
            margin: 10px auto 14px;
            padding: 8px 16px;
            max-width: 520px;
            text-align: center;
            background: #e6f2ff;
            border-radius: 999px;
            font-weight: 700;
            color: var(--blue);
            display: none;
            font-size: 0.9em;
            border: 2px solid var(--blue);
        }
        
        .controls {
            text-align: center;
            margin: 18px 0 8px;
        }
        
        button {
            padding: 8px 20px;
            font-size: 14px;
            border: 2px solid var(--border);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.25s ease;
            margin: 0 6px;
            font-weight: 700;
            background:#fff;
            color: var(--ink);
        }
        
        #calculateBtn {
            background: linear-gradient(135deg, #e6f2ff 0%, #cce0ff 100%);
            color: #000;
            border-color: var(--blue);
        }
        
        #calculateBtn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 14px rgba(0,0,0,0.18);
        }
        
        #resetBtn {
            background: linear-gradient(135deg, #ffe6ea 0%, #ffd1da 100%);
            color: #000;
            border-color: var(--red);
        }
        
        #resetBtn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 14px rgba(0,0,0,0.18);
        }
        
        #results {
            margin-top: 12px;
            padding: 12px;
            background: #fff;
            border-radius: 12px;
            min-height: 130px;
            border: 2px solid var(--border);
        }
        
        .calculation-display {
            background: #fff;
            padding: 14px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            font-size: 0.95em;
            border: 2px solid #e0e0e0;
        }
        
        .calculation-line {
            margin: 9px 0;
            font-size: 1em;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .fraction {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            margin: 0 4px;
            vertical-align: middle;
        }
        
        .fraction .numerator {
            padding: 2px 4px;
            border-bottom: 2px solid black;
            background:#fff;
        }
        
        .fraction .denominator {
            padding: 2px 4px;
            background:#fff;
        }
        
        .highlight-yellow {
            background: rgba(255, 224, 102, 0.7);
            padding: 1px 3px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .highlight-purple {
            background: rgba(125, 211, 252, 0.7);
            padding: 1px 3px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .ip-result {
            margin-top: 10px;
            padding: 8px;
            border-radius: 8px;
            text-align: center;
            font-size: 1em;
            font-weight: bold;
            border: 2px solid transparent;
        }
        
        .precipitate-yes {
            background: #ffe0e6;
            border-color: #ff1744;
            color: #ff1744;
        }
        
        .precipitate-no {
            background: #ccffdb;
            border-color: #00c853;
            color: #00a944;
        }
        
        .info-note {
            text-align: center;
            color: var(--muted);
            font-style: italic;
        }
        
        sup, sub {
            font-size: 0.75em;
        }
        
        /* Animation styles */
        .animation-container {
            display: none;
            text-align: center;
            padding: 20px 0;
            position: relative;
            min-height: 280px;
            overflow: visible;
        }
        
        .animation-container.active {
            display: block;
        }
        
        .beakers-pouring-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 240px;
            position: relative;
            height: 220px;
        }
        
        .pouring-wrapper {
            position: relative;
            flex: 0 0 135px;
            text-align: center;
        }
        
        .pouring-beaker {
            width: 135px;
            height: 165px;
            position: relative;
            border: 4px solid var(--blue);
            border-top: none;
            border-radius: 0 0 50px 50px;
            transition: all 0.5s ease;
            background: linear-gradient(to bottom, transparent 100%);
            margin: 0 auto;
        }
        
        .pouring-beaker.left {
            transform-origin: bottom center;
            animation: pourLeft 2.5s ease-in-out forwards;
        }
        
        .pouring-beaker.right {
            transform-origin: bottom center;
            animation: pourRight 2.5s ease-in-out forwards;
        }
        
        @keyframes pourLeft {
            0%, 30% {
                transform: rotate(0deg) translateY(0);
            }
            50%, 70% {
                transform: rotate(18deg) translateY(-10px);
            }
            100% {
                transform: rotate(0deg) translateY(0);
            }
        }
        
        @keyframes pourRight {
            0%, 30% {
                transform: rotate(0deg) translateY(0);
            }
            50%, 70% {
                transform: rotate(-18deg) translateY(-10px);
            }
            100% {
                transform: rotate(0deg) translateY(0);
            }
        }
        
        .combined-beaker-container {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: 30px;
            z-index: 10;
            text-align:center;
        }
        
        .combined-beaker {
            width: 150px;
            height: 180px;
            margin: 0 auto;
            position: relative;
            border: 4px solid var(--blue);
            border-top: none;
            border-radius: 0 0 60px 60px;
            background: linear-gradient(to bottom, transparent 100%);
        }

        /* volume text inside combined beaker, no border */
        .combined-volume{
            position:absolute;
            top:50%;
            left:50%;
            transform:translate(-50%,-50%);
            font-weight:700;
            font-size:0.9rem;
            padding:2px 8px;
            border-radius:999px;
            background:rgba(255,255,255,0.9);
        }
        
        .combined-beaker.filling {
            animation: fillBeaker 2.5s ease-in-out forwards;
        }
        
        @keyframes fillBeaker {
            0%, 40% {
                background: linear-gradient(to bottom, transparent 100%);
            }
            70%, 100% {
                background: linear-gradient(to bottom, transparent 60%, #f0f0f0 60%);
            }
        }
        
        .precipitate {
            position: absolute;
            bottom: 3px;
            left: 15%;
            right: 15%;
            height: 0;
            background: #ffffff;
            border: 2px solid var(--border);
            border-radius: 50%;
            opacity: 0;
            transition: all 1s ease-in;
        }
        
        .precipitate.show {
            animation: formPrecipitate 1s ease-in forwards;
            animation-delay: 2.5s;
        }
        
        @keyframes formPrecipitate {
            from {
                opacity: 0;
                height: 0;
            }
            to {
                opacity: 1;
                height: 25px;
            }
        }

        .animation-label {
            text-align: center;
            margin-top: 15px;
            font-weight: 600;
            color: #555;
            font-size: 0.95em;
        }
        
        .main-section.animating .beaker-display {
            display: none;
        }

        @media (max-width: 768px){
            .main-section{
                flex-direction:column;
                align-items:center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-header">
            <h1>• Mixing of Solutions •</h1>
            <p class="subtitle">Will a ppt form when the two solutions are mixed?</p>
        </div>
        
        <div class="main-section" id="mainSection">
            <div class="beaker-group">
                <div class="beaker-display">
                    <div class="beaker-visual" id="beaker1-visual"></div>
                    <div class="beaker-content" id="beaker1-content"></div>
                </div>
                <div class="radio-section" id="radioSection1">
                    <div class="radio-option" data-solution="1">
                        <input type="radio" name="group1" id="solution-1" value="1">
                        <label for="solution-1">
                            <span class="solution-info">
                                <span class="solution-line">20 cm³ of Li⁺(aq)</span>
                                <span class="solution-line">1.0 mol dm⁻³</span>
                            </span>
                        </label>
                    </div>
                    <div class="radio-option" data-solution="2">
                        <input type="radio" name="group1" id="solution-2" value="2">
                        <label for="solution-2">
                            <span class="solution-info">
                                <span class="solution-line">50 cm³ of Mg²⁺(aq)</span>
                                <span class="solution-line">0.0010 mol dm⁻³</span>
                            </span>
                        </label>
                    </div>
                    <div class="radio-option" data-solution="3">
                        <input type="radio" name="group1" id="solution-3" value="3">
                            <label for="solution-3">
                            <span class="solution-info">
                                <span class="solution-line">100 cm³ of CaCO₃(aq)</span>
                                <span class="solution-line">1×10⁻⁵ mol dm⁻³</span>
                            </span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="beaker-group">
                <div class="beaker-display">
                    <div class="beaker-visual" id="beaker2-visual"></div>
                    <div class="beaker-content" id="beaker2-content"></div>
                </div>
                <div class="radio-section" id="radioSection2">
                    <div class="radio-option" data-solution="a">
                        <input type="radio" name="group2" id="solution-a" value="a">
                        <label for="solution-a">
                            <span class="solution-info">
                                <span class="solution-line">20 cm³ of F⁻(aq)</span>
                                <span class="solution-line">0.010 mol dm⁻³</span>
                            </span>
                        </label>
                    </div>
                    <div class="radio-option" data-solution="b">
                        <input type="radio" name="group2" id="solution-b" value="b">
                        <label for="solution-b">
                            <span class="solution-info">
                                <span class="solution-line">50 cm³ of CO₃²⁻(aq)</span>
                                <span class="solution-line">0.0010 mol dm⁻³</span>
                            </span>
                        </label>
                    </div>
                    <div class="radio-option" data-solution="c">
                        <input type="radio" name="group2" id="solution-c" value="c">
                        <label for="solution-c">
                            <span class="solution-info">
                                <span class="solution-line">100 cm³ of Mg₃(PO₄)₂(aq)</span>
                                <span class="solution-line">5×10⁻⁵ mol dm⁻³</span>
                            </span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Animation container -->
        <div class="animation-container" id="animationContainer">
            <div class="beakers-pouring-container">
                <div class="pouring-wrapper">
                    <div class="pouring-beaker left" id="leftBeaker"></div>
                    <div class="beaker-content-anim" id="leftBeakerContent"></div>
                </div>
                <div class="combined-beaker-container">
                    <div class="combined-beaker" id="combinedBeaker">
                        <div class="combined-volume" id="combinedVolumeLabel"></div>
                        <div class="precipitate" id="precipitate"></div>
                    </div>
                    <div class="animation-label">Mixed Solution</div>
                </div>
                <div class="pouring-wrapper">
                    <div class="pouring-beaker right" id="rightBeaker"></div>
                    <div class="beaker-content-anim" id="rightBeakerContent"></div>
                </div>
            </div>
        </div>

        <!-- Ksp text display -->
        <div id="kspDisplay" class="ksp-display"></div>
        
        <div class="controls">
            <button id="calculateBtn">Deduce whether a ppt will form</button>
            <button id="resetBtn">Reset</button>
        </div>
        
        <div id="results">
            <p class="info-note">Select one solution from each group and click the button to see if precipitation occurs</p>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const solutions = {
            "1": { ionLabel: "Li⁺",       volumeCm3: 20,  volumeDm3: 0.020, volumeStr: "0.020", concStr: "1.0",      colorHex: "#FFE066" },
            "2": { ionLabel: "Mg²⁺",      volumeCm3: 50,  volumeDm3: 0.050, volumeStr: "0.050", concStr: "0.0010",   colorHex: "#FFE066" },
            "3": { ionLabel: "CaCO₃",     volumeCm3: 100, volumeDm3: 0.100, volumeStr: "0.100", concStr: "1 × 10⁻⁵", colorHex: "#FFE066" },
            "a": { ionLabel: "F⁻",        volumeCm3: 20,  volumeDm3: 0.020, volumeStr: "0.020", concStr: "0.010",    colorHex: "#7DD3FC" },
            "b": { ionLabel: "CO₃²⁻",     volumeCm3: 50,  volumeDm3: 0.050, volumeStr: "0.050", concStr: "0.0010",   colorHex: "#7DD3FC" },
            "c": { ionLabel: "Mg₃(PO₄)₂", volumeCm3: 100, volumeDm3: 0.100, volumeStr: "0.100", concStr: "5 × 10⁻⁵", colorHex: "#7DD3FC" }
        };

        const speciesContributions = {
            "1": { Li: { conc: 1.0,    concStr: "1.0" } },
            "2": { Mg: { conc: 0.0010, concStr: "0.0010" } },
            "3": {
                Ca:  { conc: 1e-5,   concStr: "1 × 10⁻⁵" },
                CO3: { conc: 1e-5,   concStr: "1 × 10⁻⁵" }
            },
            "a": { F:   { conc: 0.010,   concStr: "0.010" } },
            "b": { CO3: { conc: 0.0010,  concStr: "0.0010" } },
            "c": {
                Mg:  { conc: 0.00015, concStr: "0.00015" },
                PO4: { conc: 0.00010, concStr: "0.00010" }
            }
        };

        const combinations = {
            "1-a": { cationId: "Li",  cationLabel: "Li⁺", anionId: "F",   anionLabel: "F⁻",     pCat: 1, pAn: 1, ksp: 3.8e-3,  kspText: "K<sub>sp</sub> value of LiF = 3.8×10<sup>-3</sup>" },
            "1-b": { cationId: "Li",  cationLabel: "Li⁺", anionId: "CO3", anionLabel: "CO₃²⁻",  pCat: 2, pAn: 1, ksp: 2.5e-2,  kspText: "K<sub>sp</sub> value of Li₂CO₃ = 2.5×10<sup>-2</sup>" },
            "1-c": { cationId: "Li",  cationLabel: "Li⁺", anionId: "PO4", anionLabel: "PO₄³⁻",  pCat: 3, pAn: 1, ksp: 3.2e-9,  kspText: "K<sub>sp</sub> value of Li₃PO₄ = 3.2×10<sup>-9</sup>" },
            "2-a": { cationId: "Mg",  cationLabel: "Mg²⁺", anionId: "F",   anionLabel: "F⁻",     pCat: 1, pAn: 2, ksp: 3.7e-8,  kspText: "K<sub>sp</sub> value of MgF₂ = 3.7×10<sup>-8</sup>" },
            "2-b": { cationId: "Mg",  cationLabel: "Mg²⁺", anionId: "CO3", anionLabel: "CO₃²⁻",  pCat: 1, pAn: 1, ksp: 3.5e-8,  kspText: "K<sub>sp</sub> value of MgCO₃ = 3.5×10<sup>-8</sup>" },
            "2-c": { cationId: "Mg",  cationLabel: "Mg²⁺", anionId: "PO4", anionLabel: "PO₄³⁻",  pCat: 3, pAn: 2, ksp: 1e-25,   kspText: "K<sub>sp</sub> value of Mg₃(PO₄)₂ = 1×10<sup>-25</sup>" },
            "3-a": { cationId: "Ca",  cationLabel: "Ca²⁺", anionId: "F",   anionLabel: "F⁻",     pCat: 1, pAn: 2, ksp: 5.3e-9,  kspText: "K<sub>sp</sub> value of CaF₂ = 5.3×10<sup>-9</sup>" },
            "3-b": { cationId: "Ca",  cationLabel: "Ca²⁺", anionId: "CO3", anionLabel: "CO₃²⁻",  pCat: 1, pAn: 1, ksp: 2.8e-9,  kspText: "K<sub>sp</sub> value of CaCO₃ = 2.8×10<sup>-9</sup>" },
            "3-c": { cationId: "Ca",  cationLabel: "Ca²⁺", anionId: "PO4", anionLabel: "PO₄³⁻",  pCat: 3, pAn: 2, ksp: 2e-29,   kspText: "K<sub>sp</sub> value of Ca₃(PO₄)₂ = 2×10<sup>-29</sup>" }
        };

        const KSP_MGCO3 = 3.5e-8;
        let animationInProgress = false;

        function toSuperscript(exponent) {
            const map = {
                '0': '⁰', '1': '¹', '2': '²', '3': '³', '4': '⁴',
                '5': '⁵', '6': '⁶', '7': '⁷', '8': '⁸', '9': '⁹',
                '-': '⁻', '+': '⁺'
            };
            const expStr = exponent.toString();
            return expStr.split("").map(ch => map[ch] || ch).join("");
        }

        function formatNumber(num, precision) {
            if (precision === undefined) precision = 3;
            const abs = Math.abs(num);
            if (abs === 0) return "0";

            if (abs < 1e-4 || abs > 1e4) {
                const expStr = num.toExponential(precision);
                const parts = expStr.split('e');
                const mantissa = parseFloat(parts[0]).toPrecision(precision);
                const exponent = parseInt(parts[1], 10);
                return mantissa + " × 10" + toSuperscript(exponent);
            }

            const s = num.toPrecision(precision);
            return parseFloat(s).toString();
        }

        function buildNumeratorHTML(c1, v1Str, c2, v2Str) {
            let html = "";
            if (c1) {
                html += '<span class="highlight-yellow">(' + c1.concStr + ")(" + v1Str + ")</span>";
            }
            if (c2) {
                if (html) html += " + ";
                html += '<span class="highlight-purple">(' + c2.concStr + ")(" + v2Str + ")</span>";
            }
            if (!html) html = "0";
            return html;
        }

        function updateKspDisplay() {
            const r1 = document.querySelector('input[name="group1"]:checked');
            const r2 = document.querySelector('input[name="group2"]:checked');
            const box = document.getElementById("kspDisplay");
            if (!r1 || !r2) {
                box.style.display = "none";
                box.innerHTML = "";
                return;
            }
            const key = r1.value + "-" + r2.value;
            const combo = combinations[key];
            if (combo) {
                if (key === "3-c") {
                    box.innerHTML = combo.kspText +
                        '<br>K<sub>sp</sub> value of MgCO₃ = 3.5×10<sup>-8</sup>';
                } else {
                    box.innerHTML = combo.kspText;
                }
                box.style.display = "block";
            } else {
                box.style.display = "none";
                box.innerHTML = "";
            }
        }

        function setCellAppearance(cell, sol) {
            if (!cell || !sol) return;
            cell.style.backgroundColor = sol.colorHex;
            cell.style.borderColor = 'rgba(0,0,0,0.35)';
            cell.style.color = '#000';
        }

        function updateBeakerVisual(beakerId, sol, contentId) {
            const beaker = document.getElementById(beakerId);
            const label = document.getElementById(contentId);
            const maxVolume = 100;
            const fillFraction = sol.volumeCm3 / maxVolume;
            const cutoff = 100 - fillFraction * 100;

            beaker.style.background = `linear-gradient(to bottom, transparent ${cutoff}%, ${sol.colorHex} ${cutoff}%)`;

            label.innerHTML =
                sol.volumeCm3 + " cm³ of " + sol.ionLabel + "(aq)<br>" +
                sol.concStr + " mol dm⁻³";

            setCellAppearance(label, sol);
        }

        const radios = document.querySelectorAll('input[type="radio"]');
        for (let i = 0; i < radios.length; i++) {
            radios[i].addEventListener("change", function () {
                const group = this.name;
                const value = this.value;
                const sol = solutions[value];

                const sameGroup =
                    document.querySelectorAll('input[name="' + group + '"]');
                for (let j = 0; j < sameGroup.length; j++) {
                    sameGroup[j].closest(".radio-option").classList.remove("selected");
                }
                this.closest(".radio-option").classList.add("selected");

                if (group === "group1") {
                    updateBeakerVisual("beaker1-visual", sol, "beaker1-content");
                } else {
                    updateBeakerVisual("beaker2-visual", sol, "beaker2-content");
                }

                updateKspDisplay();
            });
        }

        function runAnimation(willPrecipitate, s1, s2) {
            if (animationInProgress) return;
            animationInProgress = true;
            
            document.getElementById("radioSection1").classList.add("hidden");
            document.getElementById("radioSection2").classList.add("hidden");
            document.getElementById("mainSection").classList.add("animating");
            document.getElementById("animationContainer").classList.add("active");
            
            const leftBeaker = document.getElementById("leftBeaker");
            const rightBeaker = document.getElementById("rightBeaker");
            const combinedBeaker = document.getElementById("combinedBeaker");
            const combinedVolumeLabel = document.getElementById("combinedVolumeLabel");
            const precipitate = document.getElementById("precipitate");
            const leftCell = document.getElementById("leftBeakerContent");
            const rightCell = document.getElementById("rightBeakerContent");
            
            const maxVolume = 100;
            const leftFill = 100 - (s1.volumeCm3 / maxVolume) * 100;
            const rightFill = 100 - (s2.volumeCm3 / maxVolume) * 100;

            // Show fill in the original beakers during most of the animation
            leftBeaker.style.background =
                `linear-gradient(to bottom, transparent ${leftFill}%, ${s1.colorHex} ${leftFill}%)`;
            rightBeaker.style.background =
                `linear-gradient(to bottom, transparent ${rightFill}%, ${s2.colorHex} ${rightFill}%)`;
            
            // Two-line labels under animated beakers
            leftCell.innerHTML = 
                s1.volumeCm3 + " cm³ of " + s1.ionLabel + "(aq)<br>" +
                s1.concStr + " mol dm⁻³";
            rightCell.innerHTML = 
                s2.volumeCm3 + " cm³ of " + s2.ionLabel + "(aq)<br>" +
                s2.concStr + " mol dm⁻³";

            setCellAppearance(leftCell, s1);
            setCellAppearance(rightCell, s2);

            const totalVolume = s1.volumeCm3 + s2.volumeCm3;
            // total volume text appears later, so start empty
            combinedVolumeLabel.textContent = "";
            
            leftBeaker.classList.remove("left");
            rightBeaker.classList.remove("right");
            combinedBeaker.classList.remove("filling");
            precipitate.classList.remove("show");
            
            void leftBeaker.offsetWidth;
            
            leftBeaker.classList.add("left");
            rightBeaker.classList.add("right");
            combinedBeaker.classList.add("filling");
            
            if (willPrecipitate) {
                precipitate.classList.add("show");
            }

            // Animation duration ~2.5 s. At 1.5 s (1 s before end):
            // 1) remove fill from original beakers
            // 2) show total volume label in combined beaker
            setTimeout(() => {
                leftBeaker.style.background =
                    "linear-gradient(to bottom, transparent 100%)";
                rightBeaker.style.background =
                    "linear-gradient(to bottom, transparent 100%)";
                combinedVolumeLabel.textContent = totalVolume + " cm³";
            }, 1500);

            // Keep blocking new animations a bit longer, then release
            setTimeout(() => {
                setTimeout(() => {
                    animationInProgress = false;
                }, 1000);
            }, 3500);
        }

        function calculate() {
            const r1 = document.querySelector('input[name="group1"]:checked');
            const r2 = document.querySelector('input[name="group2"]:checked');
            if (!r1 || !r2) {
                document.getElementById("results").innerHTML =
                    '<p class="info-note">Please select one solution from each group</p>';
                return;
            }

            const key = r1.value + "-" + r2.value;
            const combo = combinations[key];
            if (!combo) {
                document.getElementById("results").innerHTML =
                    '<p class="info-note">This combination is not defined.</p>';
                return;
            }

            const s1 = solutions[r1.value];
            const s2 = solutions[r2.value];
            const totalV = s1.volumeDm3 + s2.volumeDm3;

            function mixedConcentration(speciesId) {
                const c1 = speciesContributions[r1.value] &&
                           speciesContributions[r1.value][speciesId];
                const c2 = speciesContributions[r2.value] &&
                           speciesContributions[r2.value][speciesId];
                let moles = 0;
                if (c1) moles += c1.conc * s1.volumeDm3;
                if (c2) moles += c2.conc * s2.volumeDm3;
                const conc = moles / totalV;
                return { conc: conc, c1: c1, c2: c2 };
            }

            const cat = mixedConcentration(combo.cationId);
            const an = mixedConcentration(combo.anionId);

            const cCat = cat.conc;
            const cAn = an.conc;

            const ionProduct =
                Math.pow(cCat, combo.pCat) * Math.pow(cAn, combo.pAn);
            
            const willPrecipitate = ionProduct > combo.ksp;
            runAnimation(willPrecipitate, s1, s2);

            let html = '<div class="calculation-display">';

            html += '<div class="calculation-line">';
            html += "[" + combo.cationLabel + "]<sub>on mixing</sub> = ";
            html += '<div class="fraction">' +
                    '<span class="numerator">' +
                    buildNumeratorHTML(cat.c1, s1.volumeStr, cat.c2, s2.volumeStr) +
                    "</span>" +
                    '<span class="denominator">' + s1.volumeStr + " + " + s2.volumeStr + "</span>" +
                    "</div>";
            html += " = " + formatNumber(cCat) + " mol dm⁻³";
            html += "</div>";

            html += '<div class="calculation-line">';
            html += "[" + combo.anionLabel + "]<sub>on mixing</sub> = ";
            html += '<div class="fraction">' +
                    '<span class="numerator">' +
                    buildNumeratorHTML(an.c1, s1.volumeStr, an.c2, s2.volumeStr) +
                    "</span>" +
                    '<span class="denominator">' + s1.volumeStr + " + " + s2.volumeStr + "</span>" +
                    "</div>";
            html += " = " + formatNumber(cAn) + " mol dm⁻³";
            html += "</div>";

            html += '<div class="calculation-line" style="margin-top:18px;">';
            html += "I.P. = (" + formatNumber(cCat) + ")";
            if (combo.pCat > 1) html += "<sup>" + combo.pCat + "</sup>";
            html += "(" + formatNumber(cAn) + ")";
            if (combo.pAn > 1) html += "<sup>" + combo.pAn + "</sup>";
            html += " = " + formatNumber(ionProduct);
            html += "</div>";

            html += '<div class="calculation-line" style="margin-top:10px;">';
            html += "K<sub>sp</sub> = " + formatNumber(combo.ksp);
            html += "</div>";

            if (key === "3-c") {
                if (ionProduct > combo.ksp) {
                    html += '<div class="ip-result precipitate-yes">I.P. of Ca₃(PO₄)₂ &gt; K<sub>sp</sub> ⇒ ppt forms</div>';
                } else {
                    html += '<div class="ip-result precipitate-no">I.P. of Ca₃(PO₄)₂ &lt; K<sub>sp</sub> ⇒ no ppt</div>';
                }
            } else {
                if (ionProduct > combo.ksp) {
                    html += '<div class="ip-result precipitate-yes">I.P. &gt; K<sub>sp</sub> ⇒ ppt forms</div>';
                } else {
                    html += '<div class="ip-result precipitate-no">I.P. &lt; K<sub>sp</sub> ⇒ no ppt</div>';
                }
            }

            if (key === "3-c") {
                const mgCat = mixedConcentration("Mg");
                const co3An = mixedConcentration("CO3");

                const cMg = mgCat.conc;
                const cCO3 = co3An.conc;
                const ipMgCO3 = cMg * cCO3;

                html += '<div class="calculation-line" style="margin-top:18px;">';
                html += "[Mg²⁺]<sub>on mixing</sub> = ";
                html += '<div class="fraction">' +
                        '<span class="numerator">' +
                        buildNumeratorHTML(mgCat.c1, s1.volumeStr, mgCat.c2, s2.volumeStr) +
                        "</span>" +
                        '<span class="denominator">' + s1.volumeStr + " + " + s2.volumeStr + "</span>" +
                        "</div>";
                html += " = " + formatNumber(cMg) + " mol dm⁻³";
                html += "</div>";

                html += '<div class="calculation-line">';
                html += "[CO₃²⁻]<sub>on mixing</sub> = ";
                html += '<div class="fraction">' +
                        '<span class="numerator">' +
                        buildNumeratorHTML(co3An.c1, s1.volumeStr, co3An.c2, s2.volumeStr) +
                        "</span>" +
                        '<span class="denominator">' + s1.volumeStr + " + " + s2.volumeStr + "</span>" +
                        "</div>";
                html += " = " + formatNumber(cCO3) + " mol dm⁻³";
                html += "</div>";

                html += '<div class="calculation-line" style="margin-top:18px;">';
                html += "I.P. (for MgCO₃) = (" + formatNumber(cMg) + ")(" + formatNumber(cCO3) + ")";
                html += " = " + formatNumber(ipMgCO3);
                html += "</div>";

                html += '<div class="calculation-line" style="margin-top:10px;">';
                html += "K<sub>sp</sub> (for MgCO₃) = " + formatNumber(KSP_MGCO3);
                html += "</div>";

                html += '<div class="ip-result precipitate-no">I.P. of MgCO₃ &lt; K<sub>sp</sub> ⇒ no ppt</div>';
            }

            html += "</div>";

            document.getElementById("results").innerHTML = html;
            updateKspDisplay();
        }

        function resetAll() {
            const radios = document.querySelectorAll('input[type="radio"]');
            for (let i = 0; i < radios.length; i++) {
                radios[i].checked = false;
            }
            const options = document.querySelectorAll(".radio-option");
            for (let j = 0; j < options.length; j++) {
                options[j].classList.remove("selected");
            }

            const b1 = document.getElementById("beaker1-visual");
            const b2 = document.getElementById("beaker2-visual");
            const c1 = document.getElementById("beaker1-content");
            const c2 = document.getElementById("beaker2-content");

            b1.style.background = "linear-gradient(to bottom, transparent 100%)";
            b2.style.background = "linear-gradient(to bottom, transparent 100%)";
            c1.innerHTML = "";
            c2.innerHTML = "";
            c1.style.backgroundColor = "#f0f0f0";
            c2.style.backgroundColor = "#f0f0f0";

            document.getElementById("results").innerHTML =
                '<p class="info-note">Select one solution from each group and click the button to see if precipitation occurs</p>';

            const box = document.getElementById("kspDisplay");
            box.style.display = "none";
            box.innerHTML = "";
            
            document.getElementById("animationContainer").classList.remove("active");
            document.getElementById("mainSection").classList.remove("animating");
            document.getElementById("radioSection1").classList.remove("hidden");
            document.getElementById("radioSection2").classList.remove("hidden");
            
            const leftBeaker = document.getElementById("leftBeaker");
            const rightBeaker = document.getElementById("rightBeaker");
            const combinedBeaker = document.getElementById("combinedBeaker");
            const precipitate = document.getElementById("precipitate");
            const leftCell = document.getElementById("leftBeakerContent");
            const rightCell = document.getElementById("rightBeakerContent");
            const combinedVolumeLabel = document.getElementById("combinedVolumeLabel");
            
            leftBeaker.classList.remove("left");
            rightBeaker.classList.remove("right");
            combinedBeaker.classList.remove("filling");
            precipitate.classList.remove("show");
            
            leftBeaker.style.background = "linear-gradient(to bottom, transparent 100%)";
            rightBeaker.style.background = "linear-gradient(to bottom, transparent 100%)";
            combinedBeaker.style.background = "linear-gradient(to bottom, transparent 100%)";
            leftCell.innerHTML = "";
            rightCell.innerHTML = "";
            leftCell.style.backgroundColor = "#f0f0f0";
            rightCell.style.backgroundColor = "#f0f0f0";
            combinedVolumeLabel.textContent = "";
            
            animationInProgress = false;
        }

        document.getElementById("calculateBtn").addEventListener("click", calculate);
        document.getElementById("resetBtn").addEventListener("click", resetAll);
    });
    </script>
</body>
</html>
